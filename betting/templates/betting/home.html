{% extends "betting/base.html" %}
{% load betting_extras %}

{% block content %}
<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
{% if user.is_authenticated %}
<div class="quick-actions">
    <div class="action-card">
        <h3>üí∞ –ë–∞–ª–∞–Ω—Å</h3>
        <p class="balance-amount">{{ user.profile.balance }}‚ÇΩ</p>
        <a href="{% url 'deposit' %}" class="btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>
    </div>
    <div class="action-card">
        <h3>üéØ –°—Ç–∞–≤–∫–∏</h3>
        <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ active_bets_count }}</p>
        <a href="{% url 'place_bet' %}" class="btn-primary">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</a>
    </div>
    <div class="action-card">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <p>–í—ã–∏–≥—Ä–∞–Ω–æ: {{ total_won }}‚ÇΩ</p>
        <a href="{% url 'bet_history' %}" class="btn-primary">–ò—Å—Ç–æ—Ä–∏—è</a>
    </div>
</div>
{% endif %}

<!-- –°–æ–≤–µ—Ç—ã –¥–ª—è —Å—Ç–∞–≤–æ–∫ -->
<div class="tip-section">
    <h3>üí° –°–æ–≤–µ—Ç –¥–Ω—è</h3>
    <p>{% get_random_tip %}</p>
</div>

<!-- –¢–∞–π–º–µ—Ä—ã –¥–ª—è –∑–∞–±–µ–≥–æ–≤ -->
<section class="races-section">
    <h2>üèá –ë–ª–∏–∂–∞–π—à–∏–µ –∑–∞–±–µ–≥–∏</h2>
    
    {% for race in races %}
    <div class="race-card" id="race-{{ race.id }}">
        <div class="race-header">
            <h3>{{ race.name }}</h3>
            <div class="race-meta">
                <span class="race-status {{ race.status }}">{{ race.get_status_display }}</span>
                <span class="race-timer" data-datetime="{{ race.date_time|date:'c' }}">
                    {{ race.date_time|time_until }}
                </span>
            </div>
        </div>
        
        <div class="race-countdown">
            <strong>–°—Ç–∞—Ä—Ç: {{ race.date_time|date:"d.m.Y –≤ H:i" }}</strong>
        </div>
        
        <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–±–µ–≥–∞ -->
    </div>
    {% endfor %}
</section>

<!-- JavaScript –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–æ–≤ -->
<script>
function updateTimers() {
    const timers = document.querySelectorAll('.race-timer');
    timers.forEach(timer => {
        const datetime = new Date(timer.getAttribute('data-datetime'));
        const now = new Date();
        const diff = datetime - now;
        
        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            timer.textContent = `—á–µ—Ä–µ–∑ ${hours}—á ${minutes}–º`;
        } else {
            timer.textContent = '–Ω–∞—á–∞–ª—Å—è';
            timer.style.color = '#e74c3c';
        }
    });
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
setInterval(updateTimers, 60000);
updateTimers(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
</script>
{% endblock %}